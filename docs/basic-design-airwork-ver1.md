# 基本設計書（Ver.1）

**文書名**：基本設計書（Ver.1）  
**対象**：求人媒体更新代行業務のうち Airワーク採用管理の「求人一括作成（入稿）」機能を用いた更新自動化  
**前提**：Webアプリは Vercel にデプロイ／リポジトリは GitHub 管理／DBは Neon（PostgreSQL）

---

## 1. 背景・目的

### 1.1 背景

40社規模の求人更新を、媒体管理画面で個別更新する運用はスループットが出ず、コンサル業務（改善提案・効果分析）が圧迫されている。

顧客のメイン運用が「Airワーク採用管理」であり、Airワークの **求人一括作成機能（xlsx/txtアップロード）**を軸に、更新作業の“生成・検証・差分確認・実行指示”をシステム化する。

### 1.2 目的（Ver.1）

顧客との会議内容を起点に、求人原稿改善をAIで提案→人が承認→Airワークの一括入稿ファイルを自動生成し、更新を高速化する。

掲載から14日超過した求人を「鮮度維持対象」として自動検知し、停止→複製→新規掲載の運用をワークフロー化する（※Airワーク側の操作制約あり。後述）。

---

## 2. スコープ定義

### 2.1 対象（Ver.1で必ず実現）

1. 求人データの正（Single Source of Truth）をDBに保持

   Airワーク一括入稿の項目キー（例：job_offer_id, job_type, title, description 等）と整合する形で保持する。

2. AIによる改善提案（Gemini 3 Flash）

   “会議メモ＋現行求人＋制約”から改善案を生成し、差分表示・承認フローを提供。

   Gemini 3 Flash（Preview含む）の呼び出しはサーバー側から実施（APIキーはサーバー環境変数）。

3. Airワーク一括入稿ファイルの自動生成

   Airワークの一括入稿は xlsx（推奨） と txt（必要時） が公式に案内されているため、生成形式は基本xlsx、代替でtxtを扱える設計にする。

   新規作成／更新は job_offer_id の空欄／保持で分岐。

   コード値は公式コード形式厳守（例「01」と「1」は別扱い）。

4. アップロード結果（失敗時）の取り込み支援

   Airワーク側の「一括作成の履歴」から結果ファイル（zip/txt）をDLできる前提があるため、結果ファイルを本システムにアップロードしてエラー可視化する。

5. 掲載・停止の“実行手順”を運用キュー化

   Airワークは複数求人をまとめて「掲載する」「未掲載にする」が可能。

   ただし一括入稿のコード一覧上、publish_status は入力不可（＝ファイルだけで掲載状態を直接変更できない可能性が高い）ため、Ver.1は「実行キュー＋操作手順提示＋証跡管理」を標準とする。

### 2.2 非対象（Ver.1では割り切る／将来拡張）

- Airワーク以外（en-gage、ハロワ等）のAPI連携・配信ハブ統合
- 完全自動（無人）でAirワーク管理画面へログインしアップロード・掲載・停止まで行うRPA（可能性はあるが規約・2FA・脆弱性・運用リスクが大きいので別検討）
- 有料広告の一括設定（Airワーク一括作成機能では対応不可）。

---

## 3. 外部仕様（Airワーク一括入稿）の設計反映ポイント

### 3.1 一括作成機能の制約（設計に直結）

一括作成機能で できないこと（勤務地の新規登録/更新、写真一括設定、有料広告一括設定 等）が明示されている。

写真は一括で設定できないが「写真付き求人を複製して大量作成は可能」という運用逃げがある。

→ 「鮮度維持で新規掲載」を行う場合、写真継承のために“複製元”運用が必要になり得る。

### 3.2 新規／更新の判定とコード厳格性

job_offer_id が空欄＝新規作成、値あり＝更新。

コード値は公式の形式通り（ゼロ埋め含む）。

画面で入力できない矛盾値は登録されない（例：固定残業代なしなのに金額が入っている等）。

→ 生成時バリデーション必須。

### 3.3 処理時間・ファイル上限

アップロードは 完了まで数分〜10分程度かかり得る。

txtアップロードのガイドでは 50MB上限、件数上限なし が明記。

→ 大量更新時は分割生成（バッチ分割）を設計に含める。

### 3.4 掲載・停止（運用上の自動化余地）

複数求人をまとめて「掲載する」フローが公式に案内されている（未掲載で絞り込み→一括掲載）。

掲載停止（未掲載化）も求人一覧から複数選択で可能。

掲載中求人の修正は「再掲載しないと反映されない」旨が注意として記載。

→ 「更新ファイル生成→アップロード」だけでなく、必要に応じて「再掲載」までを運用キューに含める。

### 3.5 規約・掲載停止リスクを踏まえたAI設計

原稿掲載はガイドラインや法令遵守が前提で、問題があると掲載停止になり得る。

→ AI提案は「禁止・NG表現の抑制」「最低賃金等のチェック支援」「差別的表現回避」などのガードレールを設ける。

---

## 4. 全体アーキテクチャ

### 4.1 構成（論理）

- フロント：Next.js（App Router想定）で管理画面
- バック：Next.js Route Handler / Server Actions（Node runtime推奨）
- DB：Neon（PostgreSQL）
- スケジューラ：Vercel Cron Jobs（UTCで実行）
- ファイル保管：Vercel Blob または外部オブジェクトストレージ（監査証跡用）
- AI：Gemini 3 Flash（Gemini API もしくは Vertex AI 経由）

### 4.2 デプロイ/リポジトリ運用

GitHub push/PRでPreview、mainでProduction（Vercel for GitHubの標準フロー）。

Neonは Vercel連携（統合課金 or Neon側管理）または手動接続を選択可能。

### 4.3 コンポーネント図（テキスト）

管理UI（ログイン/CRM/求人編集/プレビュー/実行キュー） → API（認証・求人CRUD・AI提案・ファイル生成・結果取込） → DB（求人正本・版管理・実行ログ・マスタコード） → 生成物ストレージ（xlsx/txt/結果zip/監査ログ） → Cron（鮮度チェック、リマインド、マスタ同期）

---

## 5. 主要ユースケース（業務フロー）

### 5.1 初期オンボーディング（顧客/求人取り込み）

1. 顧客企業（クライアント）登録
2. Airワーク媒体アカウント登録（ログインID等）
3. Airワークから 求人xlsxをダウンロード → 本システムへアップロード
4. 取り込んだ行を job_offer_id キーで求人として登録

以後「更新」は job_offer_id を維持したまま差分更新して生成

> 目的：job_offer_id を確実に保持し、更新ファイル生成の精度を上げる。

### 5.2 会議→AI改善→承認→一括更新

1. 会議メモを「改善依頼」として登録（顧客要望、採用ターゲット、懸念点）
2. 対象求人を選択し、AIに提案要求（Gemini 3 Flash）
3. AI提案を差分表示（title/description/subtitle/給与等の変更点）
4. 担当が承認（または一部手修正）
5. 「更新実行」を作成 → Airワーク一括入稿ファイル（xlsx/txt）生成
6. 実行手順：Airワークでアップロード→必要なら「再掲載/掲載」まで実施（複数選択で可能）
7. 実行ログとして「アップロード日時・操作者・対象求人・生成ファイルhash」を保存

### 5.3 鮮度維持（14日超の検知→停止→複製→新規掲載）

Cronで毎日、published_at（自社の運用記録）を基に14日超を検知

対象を「鮮度維持キュー」に追加し、以下を“実行プラン”として組み立て：

1. Airワーク上で対象求人を「未掲載にする」（複数選択可能）
2. 新規掲載用に、job_offer_idを空欄にした行を生成（同一内容の新規作成）
3. 掲載は「未掲載で絞り込み→一括掲載」手順で実施

> 注意：一括入稿のコード一覧上 publish_status は入力不可のため、Ver.1では「停止・掲載の操作そのもの」はAirワーク画面操作を前提に“キュー化”します。

---

## 6. 画面設計（必要画面と追加提案）

要件の3画面に加え、Ver.1で詰まりやすい運用ポイントに対して不足画面を追加します。

### 6.1 必須画面（要件）

1. 認証画面

   - ログイン（メール+パスワード or マジックリンク）
   - ロール：Admin / Operator / ReadOnly（顧客閲覧用）

2. CRM画面（顧客・求人・媒体・ログイン情報管理）

   - 顧客企業一覧・担当者・契約情報
   - 媒体アカウント（Airワーク）登録
   - ログイン情報（※後述のセキュリティ方針に従い暗号化 or 外部Vault参照）

3. プレビュー画面（投稿チェック）

   - 変更前/変更後の差分表示
   - ガイドライン観点の警告（最低賃金、年齢/性別制限表現など）
   - AI提案の採用/却下/部分採用

### 6.2 追加提案（Ver.1で必須級）

4. 実行キュー画面（Runbook型）

   - 「生成済みファイル」一覧（顧客別・日付別・対象件数）
   - 実行手順チェックリスト（アップロード→結果確認→必要なら掲載/再掲載）
   - 掲載はまとめて可能、停止もまとめて可能を手順として埋め込む

   - 証跡（操作者、実行時刻、ファイルハッシュ）

5. ファイル生成・ダウンロード画面

   - xlsx生成（基本）
   - txt生成（環境都合の代替）
   - 分割生成（50MB上限に備える）

6. 取り込み（インポート）画面

   - AirワークからDLした求人xlsxの取り込み（job_offer_id保持）
   - 一括作成の結果ファイル（zip/txt）取り込み→エラーを求人単位に紐付けて表示

7. マスタ同期・検証画面（Airワークコード）

   - 公式「求人一括入稿用のコード一覧」を取り込んだコードマスタの閲覧
   - 変更検知（項目追加などが告知され、旧ファイルが使えなくなるケースがある）

---

## 7. データ設計（Neon / PostgreSQL）

**方針**：

- 求人データの版管理（AI提案・人の承認・実行履歴を残す）
- Airワーク項目は「項目定義＋JSONB値」で拡張可能にし、項目追加にも追従（告知で項目が増え得る）

### 7.1 テーブル一覧（概念設計）

**A. 認証・権限**

- users
  - id, email, name
- roles
  - id, name（admin/operator/readonly）
- user_roles
  - user_id, role_id
- sessions（Authライブラリ採用時）

**B. 顧客CRM**

- clients
  - id, name, industry, note
- client_contacts
  - id, client_id, name, email, phone
- client_accounts（媒体アカウント）
  - id, client_id
  - channel（"airwork" 固定：Ver.1）
  - login_id（表示用）
  - credential_ref（暗号化データ or 外部Vault参照キー）
  - airwork_version（2.0/不明など）
- client_meetings
  - id, client_id, held_at, memo（議事録）

**C. 求人（正本）＋版管理**

- jobs
  - id, client_id
  - title_current
  - status（draft/approved/queued/executed/stale 等）
  - published_at（自社の運用記録：鮮度判定基準）
- job_versions
  - id, job_id, version_no
  - source（import/ai/manual）
  - airwork_payload（JSONB：Airワーク項目キー＝値）
  - diff_summary（JSONB：主要差分）
  - approved_by, approved_at

> airwork_payload のキーは Airワーク公式の項目キー（例：job_offer_id, job_type, title, description, subtitle…）をそのまま採用すると生成が簡単です。

**D. Airワークコード・項目定義（公式参照）**

- airwork_field_definitions
  - field_key（例：job_offer_id）
  - label_ja（求人番号 等）
  - input_type（text/number/code/id/readonly）
  - is_editable（入力不可の管理：publish_status 等）
  - spec_version（項目変更に備える）
- airwork_code_values
  - code_type（例：job_type, salary_form, remote_flg…）
  - code, name_ja
- airwork_feature_ids
  - feature_group（仕事内容の特徴/勤務地の特徴 等）
  - id, name_ja

**E. 実行・ファイル・監査**

- execution_runs
  - id, client_id, channel（airwork）
  - run_type（update/refresh）
  - status（generated/downloaded/uploaded/verified/failed）
  - generated_by, generated_at
  - file_format（xlsx/txt）
  - file_uri, file_sha256
- execution_run_items
  - run_id, job_id, job_version_id
  - action（create/update/unpublish/publish_instruction 等）
- audit_logs
  - id, actor_user_id, action, target_type, target_id, created_at, payload

### 7.2 Airワーク“入力不可”項目の扱い

approval_status, publish_status, client_code は入力不可として定義し、取り込み時は保持するが、生成時は上書きしない。

publish_status を変えたい要件（未掲載化など）は、Ver.1では「実行キューの手順」として扱い、Airワーク画面操作の証跡を残す。

---

## 8. CSV/XLSX生成設計（Airワーク一括入稿）

### 8.1 生成方針

xlsx生成を基本（公式推奨）。

例外的に、環境都合でxlsxアップロードができない場合に備え txt（タブ区切り） 生成も用意。

### 8.2 生成ルール（コア）

- job_offer_id
  - 新規：空欄
  - 更新：保持（空欄にすると新規作成になってしまう）
- コード値：公式形式厳守（ゼロ埋め含む）
- 矛盾値の排除：画面入力の条件分岐に合わせて不要項目を空にする（固定残業代なしなら金額系を空等）

### 8.3 エラー取り込み

Airワーク側でアップロードに失敗した場合、「一括作成の履歴」から結果ファイル（zip/txt）をDL→不備箇所を確認する手順がある。

→ 本システムでは、結果ファイルをアップロードさせて

- 「求人（job_offer_id / title）× 不備項目 × エラー内容」を一覧化
- 次回生成時に自動修正候補（空欄化、コード補正、文字種警告）を提示

---

## 9. AI（Gemini 3 Flash）設計

### 9.1 接続方式

Gemini API（REST）で gemini-3-flash-preview などのモデルをサーバー側から呼び出す（APIキーは環境変数）。

企業要件（監査/請求/閉域）次第で Vertex AI 経由に切替可能。

### 9.2 プロンプト設計（テンプレ）

**入力**：

- 会議メモ（顧客の要望・NG・ターゲット・競合比較）
- 現行求人（Airワーク項目：title/description/subtitle/salary 等）
- 制約（文字数、禁止表現、法令/ガイドライン観点）

**出力（構造化JSON推奨）**：

- suggested_changes: [{field_key, before, after, rationale}]
- risk_flags: [{type, detail, severity}]
- checklist: [人が確認すべき観点]

### 9.3 ガードレール

原稿掲載ガイドラインや法令遵守が前提で、問題があると掲載停止の可能性がある旨が明記されているため、AI出力には必ず “リスク検知” を含める。

---

## 10. バッチ（Cron）設計

### 10.1 実行基盤

Vercel Cron Jobs：vercel.json でスケジュールし、指定パスにHTTP GETが飛ぶ（UTC）。

### 10.2 Cron一覧（Ver.1）

1. `0 18 * * *`（例：日本時間3時）鮮度チェック

   - published_at <= now()-14days を抽出し、execution_runs（run_type=refresh）を作る
   - 実行キューに「未掲載化」「新規作成」「掲載」手順を自動生成

2. `0 3 * * 1`（例：毎週）Airワーク項目/コード変更監視

   - 公式お知らせ（項目追加で旧ファイルが使えなくなる旨）に備え、airwork_field_definitions.spec_version を更新し差分を通知

---

## 11. セキュリティ設計

### 11.1 認証・権限

- 役割ベース（Admin/Operator/ReadOnly）
- 顧客閲覧ユーザーは「閲覧のみ」「承認のみ」など最小権限

### 11.2 ログイン情報（媒体アカウント）の扱い

原則：本システムに平文で保存しない

**実装案（優先順）**：

1. 外部Vault（1Password/Bitwarden等）参照キーのみ保存
2. DB保存が必要なら、アプリ側で暗号化（AES-GCM等）＋復号鍵はVercel環境変数（KMS相当運用）

監査ログ：誰がいつ復号・閲覧したかを必ず記録（audit_logs）

### 11.3 APIキー

Gemini APIキーはサーバー環境変数（x-goog-api-keyヘッダで送る例が公式にある）。

DB接続情報もVercel環境変数、Neonの推奨連携パスを利用。

---

## 12. 運用設計（“自動化できる範囲”の明確化）

### 12.1 Ver.1の到達点（現実的に最も効く自動化）

**作業の8割**：

- 差分抽出、AI提案、承認、ファイル生成、エラー解析、実行手順のテンプレ化、証跡保存

**Airワーク画面操作（アップロード/掲載/未掲載）**：

まとめて操作できるため、ここは“実行キュー”で迷いを無くして処理時間を最小化する。

### 12.2 “完全自動”を狙う場合の追加検討（Ver.2候補）

- ブラウザ自動操作（Playwright等）でアップロードや掲載ボタンまで押す
- 2FA・規約・UI変更耐性・事故時責任の整理が必須

Ver.1では実施しない前提で設計（ただし将来拡張できるよう execution_runs を用意）

---

## 13. 受け入れ条件（Ver.1）

1. Airワーク求人の取り込み→編集→差分プレビュー→承認→一括入稿ファイル生成が一連でできる
2. コード値・入力条件矛盾をバリデーションし、失敗率を下げられる
3. 失敗時の結果ファイルを取り込み、どの求人のどの項目が原因かを管理画面で特定できる
4. 鮮度維持の対象抽出（14日超）と実行キュー生成が自動で回る（Cron）
5. 掲載/停止の手順が明確で、複数求人の一括操作が前提として組み込まれている

---

## 14. 主要リスクと対策（設計上の重要論点）

- **Airワークの項目仕様変更**：旧ファイルが使えなくなる旨が告知されている → テンプレ取り込み＋spec_version管理＋差分通知。
- **掲載状態の直接制御**：publish_status は入力不可 → 実行キュー方式で運用を固め、将来の自動化は別フェーズ。
- **修正反映には再掲載が必要なケースがある** → 更新実行の手順に「再掲載」工程を含める。
- **掲載停止リスク（ガイドライン/法令）** → AI出力にリスクフラグ＋人の最終承認を必須化。
