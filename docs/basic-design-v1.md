# 基本設計書（Ver.1）
Airワーク一括入稿（Excel/TSV）× AI改善提案 × 更新運用自動化システム

---

## 0. ドキュメント情報
- 文書名：基本設計書（Ver.1）
- 対象：求人媒体更新代行業務のうち **Airワーク採用管理の「求人一括入稿」機能**を用いた更新自動化
- 前提：
  - デプロイ：Vercel
  - リポジトリ：GitHub（PR運用）
  - DB：Neon（Postgres）
  - ファイル：Vercel Blob（生成ファイル・結果ファイル・証跡）
  - AI：Gemini Flash 3.0（サーバー側呼び出し）
- 作成日：2026-02-07
- 版：0.1

---

## 1. 背景・目的

### 1.1 背景
- 40社規模×複数求人×頻繁な更新を、媒体管理画面で人手更新しており運用が飽和している。
- 顧客の主利用媒体が「Airワーク」であり、Airワークの一括入稿（Excelテンプレート / TSV）を軸に更新業務を標準化できる。

### 1.2 目的（Ver.1）
- 求人内容の「正（Single Source of Truth）」をNeonに集約し、入力画面で一元管理する。
- 会議メモを起点にAI（Gemini Flash 3.0）が改善案を提示し、承認後に一括入稿ファイルを自動生成して更新を高速化する。
- 掲載から14日超過した求人を「鮮度維持対象」として検知し、未掲載化→複製→新規掲載の運用を回せる状態にする（Ver.1は“実行支援＋ToDo化＋証跡”で成立させる）。

---

## 2. スコープ定義

### 2.1 対象（Ver.1で必ず実現）
1) **求人データの正本DB**
- Airワーク一括入稿で用いる項目キーと整合する形で、求人情報を保持する（job_offer_id 等を含む）。

2) **AI改善提案（Gemini Flash 3.0）**
- 会議メモ＋現行求人＋制約を入力し、改善案（差分＋理由＋リスク）を構造化出力。
- AI呼び出しはサーバー側のみ（APIキーはサーバーENV）。

3) **Airワーク一括入稿ファイル生成**
- 生成形式は Excel（推奨）を基本とし、必要に応じてTSV（.txt）も扱う。
- 新規／更新は `job_offer_id` の有無で制御（空欄＝新規、値あり＝更新）。
- 公式のコード値・規定に沿って、出力前バリデーションを行う。

4) **実行ログ・証跡**
- 生成ファイル、実行者、実行日時、対象求人、差分・ハッシュ等を保管（監査/説明責任）。

5) **鮮度維持（14日超過検知）**
- Cronで日次検知し、対象求人に対して「未掲載化」「新規掲載（複製）」の実行計画（ToDo）を作成。
- 未掲載化/掲載など“Airワーク画面操作が必要な工程”は、Ver.1ではToDo化＋手順提示＋証跡添付で運用する。

6) **エラー取り込み支援**
- Airワーク側の入稿結果（エラー内容）を取り込み、求人単位で原因表示・次回修正のToDo化を行う。

### 2.2 非対象（Ver.1では割り切る／将来拡張）
- Airワーク以外（en-gage、ハローワーク等）への一括更新
- Airワーク画面操作の完全自動化（RPA/ブラウザ自動操作）
- 有料広告設定、写真一括設定など、一括入稿で扱えない領域の完全自動化

---

## 3. 外部仕様（Airワーク一括入稿）反映ポイント

### 3.1 一括入稿の制約
- 一括入稿では「入力不可」の項目が存在するため、アプリ側で“参照専用”として扱う（例：掲載状態/承認状態など）。
- 画面操作（未掲載化、掲載、再掲載）が必要な工程は、Ver.1ではToDoで運用する。

### 3.2 新規／更新の分岐
- `job_offer_id` が空欄：新規作成
- `job_offer_id` が存在：更新
- これを壊すと「更新のつもりが新規」事故が起こるため、DBで厳密に保持し、生成時にも保護する。

### 3.3 コード厳密性と入力条件
- コード（ゼロ埋め等）を含む値は“文字列として”扱う（数値化しない）。
- 条件依存フィールド（例：固定残業代の有無）など、矛盾値は出力前に排除し、警告として提示する。

---

## 4. 全体アーキテクチャ

### 4.1 論理構成
- フロント：Next.js（App Router）管理画面
- バック：Route Handler / Server Actions（Node runtime）
- DB：Neon（Postgres）
- ファイル：Vercel Blob（入稿ファイル、結果ファイル、証跡）
- AI：Gemini Flash 3.0（サーバー側）
- 定期実行：Vercel Cron（鮮度維持・通知・マスタチェック）

### 4.2 デプロイ/リポジトリ運用
- GitHub PR → Vercel Preview
- main → Vercel Production
- SecretsはVercel/ローカルENVのみ（repoには置かない）

---

## 5. 主要ユースケース（業務フロー）

### 5.1 初期オンボーディング（顧客・求人取り込み）
1) 顧客（Client）登録
2) Airワーク媒体アカウント情報（運用URL・ログインID等）登録
3) Airワークから求人テンプレート/求人データを取得 → 本システムへ取り込み
4) `job_offer_id` をキーに求人紐付けを確立（更新の前提）

### 5.2 会議→AI改善→承認→一括更新
1) 会議メモ登録（ターゲット、訴求、NG、改善方針）
2) 対象求人選択 → AI提案生成
3) 差分プレビュー（before/after、理由、リスク）
4) 担当者が承認（または部分修正）
5) Run（更新実行）作成 → 一括入稿ファイル生成 → ダウンロード
6) Airワーク側でアップロード実施（ToDoチェック）
7) 結果取り込み（成功/失敗、失敗の原因）

### 5.3 鮮度維持（14日超）
1) Cronが日次で掲載から14日超の求人を検知
2) 対象を「鮮度維持Run候補」に追加
3) ToDo自動生成：
   - 旧求人を未掲載化（手動実行）
   - 複製（新規掲載用：job_offer_id空欄）ファイル生成
   - 新規掲載（手動実行）
   - 新しく発番された job_offer_id の取り込み・紐付け更新（同期ToDo）

---

## 6. 画面設計

### 6.1 必須画面（要件）
1) 認証画面
- ログイン
- ロール（Admin / Operator / ReadOnly）

2) CRM画面
- 顧客一覧/詳細
- 媒体アカウント（Airワーク）管理
- ログイン情報は原則「参照キー/運用メモ」で管理（平文保管しない方針）

3) プレビュー画面
- 差分表示（項目単位）
- AI提案の採用/却下/部分採用
- リスク警告表示

### 6.2 追加提案（Ver.1で実運用に必要）
4) 実行キュー（Runbook）画面
- 生成ファイル一覧（顧客別・日付別）
- 実行手順チェックリスト
- 実行証跡（スクショ/メモ/担当者/時刻）

5) インポート/同期画面
- AirワークからDLした求人ファイルの取り込み
- 入稿結果（エラー）ファイルの取り込み→原因表示

6) Airワークコード/マスタ確認画面
- 公式のコード一覧・規定を取り込んだマスタを閲覧
- 仕様変更に備えた差分管理（spec_version等）

7) ToDo画面
- 未掲載化、再掲載、アップロード、結果取り込み等の“手動工程”を一元管理

---

## 7. データ設計（Neon / Postgres）

### 7.1 設計方針
- 変更に強い：Airワーク項目は「項目定義 + JSONB payload」で保持（項目追加に追従）
- 版管理：AI提案・人手修正・承認・適用の履歴を保持
- 実行/証跡：Run・ToDo・監査ログを必須とする

### 7.2 テーブル一覧（最小）
#### 認証・権限
- organizations
- users（role含む）
- sessions（採用する認証方式に応じて）

#### CRM
- clients
- channel_accounts（Airワーク）

#### Airワーク公式コード参照
- airwork_fields（項目定義）
- airwork_codes（コード値）
- airwork_locations（working_location_id 等：顧客別）

#### 求人・版管理
- jobs（社内の求人単位）
- job_postings（媒体上の求人：job_offer_id紐付け）
- job_revisions（内容の版：payload_json、status）

#### AI
- ai_proposals（入力/出力の保存）

#### 実行・運用
- runs（更新/鮮度維持）
- run_items（求人単位、create/update）
- todos（手動工程）
- audit_logs（監査）

### 7.3 入力不可項目の扱い
- 一括入稿で入力不可な項目はDBに保持しても「参照専用」とし、出力生成時に上書きしない。

---

## 8. 入稿ファイル生成（Excel/TSV）

### 8.1 生成方針
- デフォルトはExcel生成（公式テンプレートに合わせる）
- 代替としてTSV（.txt）生成（環境都合用）
- 大量更新に備え分割生成（サイズ/件数による）

### 8.2 コアルール
- 新規：job_offer_id空欄
- 更新：job_offer_id維持
- コード値は文字列で保持し、ゼロ埋め等を崩さない
- 依存条件がある項目は矛盾値を除去して出力（警告）

### 8.3 エラー取り込み
- 結果ファイルをアップロード → どの求人のどの項目が原因かを一覧化
- 次回修正ToDoを生成

---

## 9. AI（Gemini Flash 3.0）設計

### 9.1 入力
- 会議メモ（改善方針、ターゲット、NG、優先度）
- 現行求人（payload_jsonから主要項目）
- 制約（文字数、禁止表現、必須項目）

### 9.2 出力（構造化）
- suggested_changes：field_key単位の before/after と理由
- risk_flags：コンプライアンス/表現リスクの指摘
- questions_for_human：承認前に人が確認すべき点

### 9.3 ガードレール
- AI出力は必ず「人が承認して初めて適用」する（自動適用しない）
- NG表現や誇張のチェック観点を併記する

---

## 10. Cron（定期処理）設計

### 10.1 日次：鮮度チェック
- 対象：last_published_at 等の運用記録から14日超を検知
- 出力：鮮度維持Run候補＋ToDo（未掲載化、再掲載、同期）

### 10.2 週次：コード/項目変更チェック（任意）
- airwork_fields/airwork_codes の更新手段（アップロード/手動取り込み）の運用を整える
- 仕様変更時に、フォームや生成を壊さないための検知を行う

---

## 11. セキュリティ設計

### 11.1 認証・権限
- RBAC（Admin/Operator/ReadOnly）
- 顧客閲覧は最小権限（閲覧のみ、承認のみ等）

### 11.2 Secrets
- DB接続・Blob・GeminiキーはVercelの環境変数のみ
- repoには`.env.example`のみ（ダミー値）

### 11.3 媒体ログイン情報
- 原則：平文保管しない
- 必要なら暗号化保管＋監査ログ（誰がいつ閲覧/更新したか）

---

## 12. 受け入れ条件（Ver.1）
1) 求人取り込み → 編集 → AI提案 → 承認 → 入稿ファイル生成が一連で実行できる  
2) 公式コードに基づくバリデーションで入稿失敗を減らせる  
3) 14日超の鮮度維持対象を検知し、ToDoとRunを自動生成できる  
4) 実行・結果取り込み・証跡が残り、運用が属人化しない  
5) Secretsがクライアントに露出しない（サーバー専用）

---

## 13. リスクと対策（設計上の重要論点）
- 仕様変更（項目追加/コード変更）  
  → マスタ管理（airwork_fields/codes）をDB化し、フォーム/生成に反映できる設計にする
- 掲載/未掲載など“ファイルだけで完結しない工程”  
  → ToDo + Runbook（手順）+ 証跡の運用設計で成立させる（Ver.1）
- AI出力の不適切表現  
  → 承認必須・リスクチェック・差分プレビューを標準化する
- job_offer_id事故（更新が新規になってしまう）  
  → DBで厳密保持、生成時も安全側に倒す（空欄にしない）

---

## 14. 次のステップ（実装順）
1) DB（SQL）で最小テーブル作成（Neon）
2) 基盤ディレクトリとガードレール（AGENTS/README/.env.example）
3) DB疎通の最小API（/api/health/db）
4) 求人CRUD + 版管理
5) AI提案 → 承認
6) 入稿ファイル生成（Excel/TSV）→ Run/ToDo
7) 鮮度維持Cron → ToDo自動生成
8) 結果ファイル取り込み → エラー可視化
